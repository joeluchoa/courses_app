<%= form_with(model: student) do |form| %>
  <% if student.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(student.errors.count, "error") %> prohibited this student from being saved:</h2>

      <ul>
        <% student.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card" data-controller="camera">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-person-bounding-box me-2"></i>Photo
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-4">

        <%# --- COLUMN 1: File Upload --- %>
        <div class="col-md-6">

          <%# Current photo display %>
          <% if student.photo.attached? %>
            <div class="mb-3 text-center">
              <%= image_tag student.photo.variant(resize_to_fill: [250, 250]), class: "img-thumbnail rounded-circle" %>
            </div>
          <% end %>
        </div>

        <%# --- COLUMN 2: Camera Capture --- %>
        <div class="col-md-6 border-start-md">
          <%# The file input field (with its Stimulus target) %>
          <h6>Upload a new photo</h6>
          <%= form.file_field :photo, class: "form-control", accept: "image/png,image/jpeg,image/gif", data: { camera_target: "photoInput" } %>

          <hr class="mt-1 mb-3">
          <h6>Take a new photo</h6>

          <div class="border rounded p-3 bg-light text-center">
            <video width="320" height="240" autoplay class="d-none rounded mb-2" data-camera-target="video"></video>
            <canvas class="d-none" data-camera-target="canvas"></canvas>

            <div class="mt-2">
              <button type="button" class="btn btn-secondary" data-action="click->camera#start" data-camera-target="startButton">
                <i class="bi bi-camera-video-fill me-1"></i> Start Camera
              </button>

              <button type="button" class="btn btn-primary d-none" data-action="click->camera#takePhoto" data-camera-target="takeButton">
                <i class="bi bi-camera-fill me-1"></i> Take Photo
              </button>
            </div>
            <span class="text-success mt-2 d-none fw-bold" data-camera-target="successMsg">âœ“ Photo Captured!</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <p/>

  <%# --- Other fields --- %>
  <div class="mb-3">
    <%= form.label :first_name, class: "form-label" %>
    <%= form.text_field :first_name, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :last_name, class: "form-label" %>
    <%= form.text_field :last_name, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :email, class: "form-label" %>
    <%= form.text_field :email, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :date_of_birth, class: "form-label" %>
    <%= form.date_field :date_of_birth, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :phone, class: "form-label" %>
    <%= form.text_field :phone, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :tax_code, class: "form-label" %>
    <%= form.text_field :tax_code, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :address, class: "form-label" %>
    <%= form.text_area :address, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :total_paid, class: "form-label" %>
    <%= form.number_field :total_paid, step: 1.00, class: "form-control" %>
  </div>

    <div class="mb-3">
      <h3><%= t('activerecord.models.course') %></h3>
    <%= form.fields_for :enrollments do |enrollment_form| %>
      <div class="form-check">
        <%= enrollment_form.hidden_field :course_id %>
        <%= enrollment_form.check_box :_destroy, { class: 'form-check-input' }, '0', '1' %>
        <%= enrollment_form.label :course_id, enrollment_form.object.course.name, class: 'form-check-label' %>
      </div>
    <% end %>

    <% Course.all.each do |course| %>
      <% unless course.finished? %>
        <div class="form-check">
          <input type="checkbox" name="student[enrollments_attributes][][course_id]" value="<%= course.id %>" id="student_enrollments_attributes__course_id_<%= course.id %>" class="form-check-input">
          <label class="form-check-label" for="student_enrollments_attributes__course_id_<%= course.id %>"><%= "#{course.name} (#{course.teacher.name}) - #{course.address}" %></label>
        </div>
      <% end %>
    <% end %>
  </div>

  <div class="actions">
    <%= form.submit class: "btn btn-success" %>
  </div>
<% end %>
